<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:UltrawideOverlays.ViewModels"
             xmlns:models="using:UltrawideOverlays.Models"
             xmlns:mxe="https://schemas.eremexcontrols.net/avalonia/editors"
             mc:Ignorable="d" d:DesignWidth="1280" d:DesignHeight="1000"
             x:DataType="vm:GamesPageViewModel"
             Background="{DynamicResource PrimaryBackground}"
             x:Class="UltrawideOverlays.Views.GamesPageView">
    <Design.DataContext>
        <vm:GamesPageViewModel/>
    </Design.DataContext>

    <UserControl.Styles>
        <Style Selector="Button">
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="CornerRadius" Value="5"/>
        </Style>
        <Style Selector="Label.GameName">
            <Setter Property="FontSize" Value="20"/>
        </Style>
        <Style Selector="Label.FilePath">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="DarkGray"/>
        </Style>

        <Style Selector="Button.Refresh">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource LinkAccent}"/>
            <Setter Property="FontSize" Value="18"/>
        </Style>
        <Style Selector="Button.Refresh:pointerover /template/ContentPresenter">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="Button.Refresh:pressed /template/ContentPresenter">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource PrimaryFontColor}"/>
        </Style>

        <Style Selector="ListBox.GamesList > ListBoxItem">
            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryAccent}"/>
            <Setter Property="Background" Value="{DynamicResource PrimaryBackground}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="5"/>
            <Setter Property="Margin" Value="0,5"/>
            <Setter Property="Padding" Value="10"/>
        </Style>
        <Style Selector="ListBox.GamesList > ListBoxItem:selected /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource PrimaryAccent}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource SecondaryAccent}"/>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto, *" Margin="10">
        <!-- Top Row (Labels and buttons) -->
        <StackPanel>
            <Label Name="Title" Classes="Title" Margin="0,-10" FontSize="24">Games Manager</Label>
            <Label RelativePanel.Below="Title"  Name="Subtitle" Classes="Subtitle" FontSize="16">Configure overlay windows for games</Label>
        </StackPanel>

        <!-- Content -->
        <Grid Grid.Row="1" ColumnDefinitions="2*, 20, *" >
            <Border CornerRadius="10" Background="{DynamicResource PrimaryColor}" MinWidth="300">
                <Grid RowDefinitions="*, 250" Margin="10">
                    <Grid RowDefinitions="2*, 30, Auto, 30, 3*">
                        <Grid RowDefinitions="Auto, *">
                            <Label Classes="Title" FontSize="20" Margin="0,0,5,5">Add New Game</Label>
                            <Grid Name="DragDropRectangle" DragDrop.AllowDrop="True" Background="Transparent" Grid.Row="1" ClipToBounds="True" MinWidth="300">
                                <Rectangle Grid.Row="1" Stroke="{DynamicResource PrimaryAccent}" StrokeThickness="2" StrokeDashArray="4" RadiusX="8" RadiusY="8" ></Rectangle>
                                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="0">
                                    <Image Width="64" Height="64">
                                        <Image.Source>
                                            <SvgImage Source="{StaticResource UploadIcon}"/>
                                        </Image.Source>
                                    </Image>
                                    <Label Classes="Primary" HorizontalAlignment="Center" >Drag and Drop Game Executable</Label>
                                    <Label Classes="Secondary" HorizontalAlignment="Center">Or use the options below</Label>
                                </StackPanel>
                            </Grid>
                        </Grid>
                        <StackPanel Grid.Row="2">
                            <Label Margin="0,0,0,5">Game Executable Path</Label>
                            <Grid ColumnDefinitions="*, 10, Auto">
                                <TextBox Watermark="Paste or type file path..." Text="{Binding GameExecutablePath, Mode=TwoWay}" IsEnabled="{Binding SelectedProcess, Converter={x:Static ObjectConverters.IsNull}}"/>
                                <Button Grid.Column="2" Click="BrowseButton_Clicked">Browse</Button>
                            </Grid>
                        </StackPanel>
                        <Grid Grid.Row="4" RowDefinitions="Auto,*">
                            <RelativePanel>
                                <Label RelativePanel.AlignTopWithPanel="True" Name="ProcessesLabel">Select from Running Processes</Label>
                                <Button Classes="Refresh" RelativePanel.AlignVerticalCenterWith="ProcessesLabel" RelativePanel.AlignRightWithPanel="True" Command="{Binding RefreshProcessesCommand}">Refresh</Button>
                            </RelativePanel>
                            <ListBox Grid.Row="1" Background="Transparent" ItemsSource="{Binding Processes}" SelectedItem="{Binding SelectedProcess, Mode=TwoWay}" BorderBrush="{DynamicResource PrimaryAccent}" SelectionMode="Toggle" BorderThickness="1" CornerRadius="3">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid RowDefinitions="2*,*" ColumnDefinitions="Auto, *">
                                            <Image HorizontalAlignment="Left" Width="32" Height="32" Margin="0,0,5,0" Source="{Binding Icon}"/>
                                            <Label Grid.Column="1" Classes="GameName" Content="{Binding Name}"></Label>
                                            <Label Grid.Column="1" Grid.Row="1" Classes="FilePath" Content="{Binding Path}"></Label>
                                            <Label Grid.Column="1" Grid.Row="1" Classes="FilePath" FontWeight="Bold" IsVisible="{Binding Path, Converter={x:Static StringConverters.IsNullOrEmpty}}">File path not accesible: Try running as admin</Label>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Grid>

                    <StackPanel IsVisible="{Binding GameExecutablePath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" Grid.Row="2" Spacing="20" VerticalAlignment="Bottom">
                        <Rectangle Classes="Separator"></Rectangle>
                        <Label Classes="Title" Margin="0,0,0,-20" >Game Configuration</Label>
                        <Grid Grid.Row="1" ColumnDefinitions="*, 10, *">
                            <StackPanel>
                                <Label>Game Name</Label>
                                <TextBox x:Name="GameNameTextBox" Watermark="Enter game name..." Text="{Binding GameName, Mode=TwoWay}"></TextBox>
                            </StackPanel>
                            <StackPanel Grid.Column="2">
                                <Label>Link to Overlay</Label>
                                <mxe:ComboBoxEditor x:Name="OverlayComboBox" Height="40" Watermark="Select overlay.." IsEnabled="{Binding GameName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" SelectedItem="{Binding SelectedOverlay}" DisplayMember="Name" ValueMember="Name" ItemsSource="{Binding Overlays}"/>
                            </StackPanel>
                        </Grid>
                        <StackPanel Grid.Row="2" Spacing="10" Orientation="Horizontal">
                            <Button Classes="Primary Blue" Width="150" HorizontalContentAlignment="Center" Click="LinkButton_Click" Command="{Binding MakeNewGameCommand}">
                                <Button.Content>
                                    <StackPanel Orientation="Horizontal">
                                        <Image Classes="TabIcon">
                                            <Image.Source>
                                                <SvgImage Source="{StaticResource LinkIcon}"/>
                                            </Image.Source>
                                        </Image>
                                        <Label Classes="Primary">Link</Label>
                                    </StackPanel>
                                </Button.Content>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Border>

            <Border Grid.Column="2" CornerRadius="10" Background="{DynamicResource PrimaryColor}">
                <Grid Margin="10" RowDefinitions="Auto, *">
                    <Grid ColumnDefinitions="Auto, *" Margin="5">
                        <Label Name="SavedGamesTitle" Classes="Title" FontSize="20" Margin="0,0,10,0">Saved Games</Label>
                        <TextBox Grid.Column="1" Name="Searchbox" Watermark="Search games..." HorizontalAlignment="Stretch" Background="{DynamicResource PrimaryColor}" Text="{Binding SearchBoxText, Mode=TwoWay}">
                        </TextBox>
                    </Grid>
                    <StackPanel Grid.Row="1" >
                        <Rectangle Margin="0,0,0,20" RelativePanel.AlignBottomWithPanel="True" Classes="Separator"/>
                        <ListBox Classes="GamesList" Name="Games_ListBox" Background="Transparent" ItemsSource="{Binding Games}" SelectedItem="{Binding SelectedGame}" SelectionMode="Toggle">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid RowDefinitions="*,*,*" ColumnDefinitions="*, Auto">
                                        <Label Classes="GameName" Content="{Binding Name}"/>
                                        <Label Grid.Row="1" Grid.ColumnSpan="2" Classes="FilePath" Content="{Binding ExecutablePath}"/>
                                        <Label Grid.Row="2" Classes="Primary" Content="{Binding OverlayName}"/>


                                        <StackPanel IsVisible="{Binding $parent[ListBoxItem].IsSelected}" Grid.Column="1" Grid.RowSpan="3" VerticalAlignment="Top" Spacing="5" Orientation="Horizontal">
                                            <Button Classes="Blue" Height="40" FontSize="12" Background="{DynamicResource SecondaryAccent}" Name="EditButton" Command="{Binding #Games_ListBox.((vm:GamesPageViewModel)DataContext).EditGameCommand}" CommandParameter="{Binding .}" >
                                                Edit
                                            </Button>
                                            <Button Classes="Red" Height="40" FontSize="12" Name="RemoveButton" Command="{Binding #Games_ListBox.((vm:GamesPageViewModel)DataContext).DeleteGameCommand}" CommandParameter="{Binding .}">
                                                Remove
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Grid>
    
</UserControl>